<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIMRS HR - Manajemen SDM Terpadu (Terintegrasi)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Babel for JSX transformation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Add Noto Sans Font -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#17B8A5',
                        primaryDark: '#0F8F80',
                        secondary: '#FFE17A',
                        darkBg: '#111827',
                        darkCard: '#1F2937',
                    },
                    fontFamily: {
                        sans: ['Noto Sans', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        body {
            font-family: 'Noto Sans', sans-serif;
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        .dark ::-webkit-scrollbar-track {
            background: #374151;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        .dark ::-webkit-scrollbar-thumb {
            background: #4b5563;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
        
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        .animate-fade-in {
            animation: fadeIn 0.4s ease-out forwards;
        }
        
        /* Typing indicator bounce */
        .typing-dot {
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        /* Login Background Pattern */
        .bg-pattern {
            background-image: radial-gradient(rgba(255, 255, 255, 0.1) 1px, transparent 1px);
            background-size: 20px 20px;
        }
    </style>
</head>
<body class="bg-[#F7F7F7] text-[#2C2C2C] dark:bg-gray-900 dark:text-gray-100 transition-colors duration-300">
    <div id="root"></div>

    <!-- React Application -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        import { 
            LayoutDashboard, Users, UserPlus, Activity, Search, Menu, 
            FileText, AlertTriangle, Trash2, Upload, Clock, Briefcase, 
            Award, BookOpen, Filter, MoreVertical, Eye, Edit, X, ChevronRight,
            ChevronDown, CheckCircle, Phone, Mail, MapPin, Calendar, User,
            Target, UserCheck, GraduationCap, FileBarChart, Save,
            Sun, Cloud, Moon, Shield, Stethoscope, Image as ImageIcon,
            Bot, Send, Settings, LogOut, Camera, Lock, Palette,
            EyeOff, AlertCircle
        } from 'https://esm.sh/lucide-react@0.263.1';

        // ==========================================
        // 1. KONFIGURASI API & MAPPING
        // ==========================================
        const API_BASE_URL = "https://staff-management-simrs-78e5d8a13f9a.herokuapp.com";

        // --- ENUM MAPPINGS (Frontend String <-> Backend Enum) ---
        const MAPPING = {
            GENDER: {
                'Laki-laki': 'LAKI_LAKI',
                'Perempuan': 'PEREMPUAN',
                'LAKI_LAKI': 'Laki-laki',
                'PEREMPUAN': 'Perempuan'
            },
            ROLE: {
                // Mapping sederhana Peran Backend -> Logic Frontend (General)
                'MEDIS': 'Medis',
                'NON_MEDIS': 'Non-Medis',
                'PENUNJANG_MEDIS': 'Penunjang',
                'PERAWAT_DAN_BIDAN': 'Keperawatan'
            },
            STATUS: {
                'Tetap': 'PEGAWAI_TETAP',
                'Kontrak': 'KONTRAK',
                'Mitra': 'MITRA_DOKTER_TAMU',
                'Residen': 'KONTRAK', // Fallback
                'Magang': 'KONTRAK', // Fallback
                'PEGAWAI_TETAP': 'Tetap',
                'KONTRAK': 'Kontrak',
                'MITRA_DOKTER_TAMU': 'Mitra'
            },
            // Mapping Profesi (String Frontend -> Enum Backend)
            PROFESI_TO_ENUM: {
                'Dokter Spesialis': 'DOKTER_SPESIALIS',
                'Dokter Umum': 'DOKTER_UMUM',
                'Dokter Gigi': 'DOKTER_GIGI_DAN_MULUT',
                'Perawat': 'PERAWAT',
                'Bidan': 'BIDAN',
                'Farmasi': 'FARMASI',
                'Laboratorium': 'LABORATORIUM',
                'Radiologi': 'RADIOLOGI',
                'Gizi': 'GIZI',
                'Fisioterapi': 'FISIOTERAPI',
                'Rekam Medis': 'REKAM_MEDIS',
                'Manajemen & Admin': 'MANAJEMEN_DAN_ADMIN',
                'Keuangan': 'KEUANGAN',
                'IT & SIMRS': 'IT_DAN_SIMRS',
                'Teknik (IPSRS)': 'IPSRS',
                'Keamanan': 'KEAMANAN',
                'Layanan Umum': 'LAYANAN_UMUM'
            },
            // Mapping Unit Kerja (String Frontend -> Enum Backend)
            UNIT_TO_ENUM: {
                 "Instalasi Gawat Darurat (IGD)": "INSTALASI_GAWAT_DARURAT_IGD",
                 "Rawat Inap Utama": "RAWAT_INAP",
                 "Rawat Inap (Lt 1)": "RAWAT_INAP",
                 "Rawat Inap (Lt 2)": "RAWAT_INAP",
                 "Rawat Inap (VIP)": "RAWAT_INAP",
                 "Poli Umum": "POLI_UMUM",
                 "Poli Gigi & Mulut": "POLI_GIGI_DAN_MULUT",
                 "Poli Mata": "POLI_MATA",
                 "Poli Penyakit Dalam": "POLI_PENYAKIT_DALAM",
                 "Poli Kandungan (Obgyn)": "POLI_OBYN",
                 "Poli Anak": "POLI_ANAK",
                 "Poli Kulit & Kelamin": "POLI_KULIT_DAN_KELAMIN",
                 "Poli THT": "POLI_THT",
                 "Poli Kejiwaan": "POLI_KEJIWAAN",
                 "Poli Rehabilitasi Medik": "POLI_REHABILITASI_MEDIK",
                 "Poli Saraf": "POLI_SYARAF",
                 "Poli Orthopedi": "POLI_ORTHOPEDI",
                 "Poli Bedah Umum": "POLI_BEDAH_UMUM",
                 "ICU / ICCU": "INTENSIVE_CARE_UNIT_ICU_ICCU_HCU_NICU",
                 "Instalasi Gizi (Dapur)": "GIZI",
                 "Poli Gizi": "GIZI",
                 "Laboratorium Patologi Klinik": "LABORATORIUM_PATOLOGI_KLINIK",
                 "Laboratorium Patologi Anatomi": "LABORATORIUM_PATOLOGI_ANATOMI",
                 "Bank Darah": "BANK_DARAH",
                 "Instalasi Radiologi": "RADIOLOGI",
                 "Instalasi Farmasi (Depot Rawat Jalan)": "INSTALASI_FARMASI_RAWAT_JALAN",
                 "Instalasi Farmasi (Depot Rawat Inap)": "INSTALASI_FARMASI_RAWAT_INAP",
                 "Gudang Farmasi": "INSTALASI_FARMASI_RAWAT_INAP", // Mapping terdekat
                 "Unit Rehabilitasi Medik": "FISIOTERAPI",
                 "Unit Rekam Medis & Pendaftaran": "REKAM_MEDIS",
                 "Ruang Server & IT Support": "RUANG_SERVER_DAN_IT_SUPPORT",
                 "Front Office": "FRONT_OFFICE",
                 "Back Office": "BACK_OFFICE",
                 "HRD & Diklat": "HRD_DAN_DIKLAT",
                 "Kamar Operasi (IBS)": "KAMAR_OPERASI_IBS",
                 "Kamar Bersalin (VK)": "KAMAR_BERSALIN",
                 "Ruang Nifas": "KAMAR_BERSALIN", // Mapping terdekat
                 "Maintenance & Teknisi": "IPSRS",
                 "Pos Security Utama": "KEAMANAN_DAN_KETERTIBAN",
                 "Pos Security IGD": "KEAMANAN_DAN_KETERTIBAN",
                 "Patroli": "KEAMANAN_DAN_KETERTIBAN",
                 "Sanitasi & Kebersihan": "SANITASI_DAN_KEBERSIHAN",
                 "Laundry": "LAUNDRY",
                 "Supir Ambulans": "SUPIR_AMBULANCE",
                 "Cleaning Service": "CLEANING_SERVICE",
                 "Kasir": "KEUANGAN",
                 "Akuntansi": "KEUANGAN",
                 "Unit Medical Check Up (MCU)": "POLI_UMUM" // Fallback
            }
        };

        // Helper Reverse Mapping (Enum -> Readable String)
        const ENUM_TO_PROFESI = Object.fromEntries(Object.entries(MAPPING.PROFESI_TO_ENUM).map(a => [a[1], a[0]]));
        const ENUM_TO_UNIT = Object.fromEntries(Object.entries(MAPPING.UNIT_TO_ENUM).map(a => [a[1], a[0]]));

        // Mapping Error Code -> Pesan User Friendly
        const ERROR_MESSAGES = {
            "TIDAK_ADA_HEADER": "Sesi Anda telah habis. Silakan login kembali.",
            "EMAIL_KOSONG": "Email tidak boleh kosong.",
            "PASSWORD_KOSONG": "Password tidak boleh kosong.",
            "ADMIN_TIDAK_DITEMUKAN": "Akun tidak ditemukan. Periksa email Anda.",
            "PASSWORD_SALAH": "Password salah.",
            "INTERNAL_ERROR": "Terjadi kesalahan pada server. Silakan coba lagi.",
            "TIDAK_LENGKAP": "Data form tidak lengkap. Harap isi semua field wajib.",
            "KURANG_6_KARAKTER": "Password minimal 6 karakter.",
            "EMAIL_SUDAH_DIGUNAKAN": "Email sudah terdaftar. Gunakan email lain."
        };

        const getFriendlyError = (code) => ERROR_MESSAGES[code] || `Terjadi kesalahan: ${code}`;

        // Helper Determine 'Peran' based on Category
        const getPeranFromCategory = (categoryEnum) => {
            if (['DOKTER_SPESIALIS','DOKTER_UMUM','DOKTER_GIGI_DAN_MULUT'].includes(categoryEnum)) return 'MEDIS';
            if (['PERAWAT','BIDAN'].includes(categoryEnum)) return 'PERAWAT_DAN_BIDAN';
            if (['MANAJEMEN_DAN_ADMIN','KEUANGAN','IT_DAN_SIMRS','KEAMANAN','LAYANAN_UMUM'].includes(categoryEnum)) return 'NON_MEDIS';
            return 'PENUNJANG_MEDIS';
        };

        // --- KONFIGURASI KATEGORI PROFESI (Sama seperti sebelumnya) ---
        const JOB_CATEGORIES = {
            MEDIS: ['Dokter Spesialis', 'Dokter Umum', 'Dokter Gigi'],
            KEPERAWATAN: ['Perawat', 'Bidan'],
            PENUNJANG: ['Farmasi', 'Laboratorium', 'Radiologi', 'Gizi', 'Fisioterapi', 'Rekam Medis'],
            NON_MEDIS: ['Manajemen & Admin', 'Keuangan', 'IT & SIMRS', 'Teknik (IPSRS)', 'Keamanan', 'Layanan Umum']
        };

        // --- MAPPING UNIT KERJA BERDASARKAN KATEGORI ---
        const UNIT_MAPPING = {
            'Dokter Spesialis': ["Poli Penyakit Dalam", "Poli Bedah Umum", "Poli Anak", "Poli Kandungan (Obgyn)", "Poli Mata", "Poli THT", "Poli Saraf", "Poli Jantung", "Poli Kulit & Kelamin", "Poli Kejiwaan", "Poli Rehabilitasi Medik", "Poli Orthopedi", "Rawat Inap Utama", "ICU / ICCU", "Kamar Operasi (IBS)"],
            'Dokter Umum': ["Instalasi Gawat Darurat (IGD)", "Poli Umum", "Unit Medical Check Up (MCU)"],
            'Dokter Gigi': ["Poli Gigi & Mulut"],
            'Perawat': ["Instalasi Gawat Darurat (IGD)", "Rawat Inap (Lt 1)", "Rawat Inap (Lt 2)", "Rawat Inap (VIP)", "ICU / ICCU", "Kamar Operasi (IBS)", "Poli Umum", "Poli Spesialis", "Poli Kejiwaan", "Poli Rehabilitasi Medik"],
            'Bidan': ["Kamar Bersalin (VK)", "Poli Kandungan (Obgyn)", "Ruang Nifas"],
            'Farmasi': ["Instalasi Farmasi (Depot Rawat Jalan)", "Instalasi Farmasi (Depot Rawat Inap)", "Gudang Farmasi"],
            'Laboratorium': ["Laboratorium Patologi Klinik", "Laboratorium Patologi Anatomi", "Bank Darah"],
            'Radiologi': ["Instalasi Radiologi"],
            'Gizi': ["Instalasi Gizi (Dapur)", "Poli Gizi"],
            'Fisioterapi': ["Unit Rehabilitasi Medik"],
            'Rekam Medis': ["Unit Rekam Medis & Pendaftaran"],
            'Manajemen & Admin': ["Front Office", "Back Office", "HRD & Diklat", "Keuangan"],
            'Keuangan': ["Kasir", "Akuntansi"],
            'IT & SIMRS': ["Ruang Server & IT Support"],
            'Teknik (IPSRS)': ["Maintenance & Teknisi"],
            'Keamanan': ["Pos Security Utama", "Pos Security IGD", "Patroli"],
            'Layanan Umum': ["Cleaning Service", "Laundry", "Supir Ambulans", "Sanitasi & Kebersihan"]
        };

        const REQUIRED_SIP_DOCS = [...JOB_CATEGORIES.MEDIS, ...JOB_CATEGORIES.KEPERAWATAN, ...JOB_CATEGORIES.PENUNJANG];

        // ==========================================
        // 2. KOMPONEN LOGIN (AUTH)
        // ==========================================

        const BrandSidebar = () => (
            <div className="hidden lg:flex w-1/2 bg-[#17B8A5] relative overflow-hidden flex-col justify-between p-12 text-white h-screen fixed left-0 top-0">
                <div className="absolute inset-0 bg-pattern opacity-30"></div>
                <div className="absolute -top-20 -right-20 w-80 h-80 bg-white opacity-10 rounded-full blur-3xl"></div>
                <div className="absolute bottom-10 left-10 w-40 h-40 bg-teal-900 opacity-20 rounded-full blur-2xl"></div>

                <div className="relative z-10 flex items-center gap-3">
                    <div className="bg-white p-2 rounded-lg text-[#17B8A5]">
                        <Activity size={32} strokeWidth={2.5} />
                    </div>
                    <h1 className="text-3xl font-bold tracking-tight">SIMRS <span className="font-light opacity-90">HR</span></h1>
                </div>

                <div className="relative z-10 space-y-6">
                    <h2 className="text-4xl font-bold leading-tight">Sistem Kepegawaian <br/> Rumah Sakit Terintegrasi.</h2>
                    <p className="text-teal-50 text-lg font-light max-w-md">
                        Kelola akses masuk staf medis dan administrasi dengan aman dan terintegrasi dengan Database.
                    </p>
                </div>

                <div className="relative z-10 text-xs opacity-60">&copy; 2024 SIMRS HR System.</div>
            </div>
        );

        const InputField = ({ label, type, placeholder, icon: Icon, value, onChange }) => {
            const [showPass, setShowPass] = useState(false);
            const isPassword = type === 'password';
            
            return (
                <div className="space-y-1.5">
                    <label className="text-sm font-semibold text-gray-700">{label}</label>
                    <div className="relative group">
                        <div className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 group-focus-within:text-[#17B8A5] transition-colors">
                            <Icon size={18} />
                        </div>
                        <input 
                            type={isPassword && showPass ? 'text' : type}
                            className="w-full pl-10 pr-10 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-[#17B8A5] bg-gray-50 focus:bg-white text-sm transition-all"
                            placeholder={placeholder} 
                            value={value} 
                            onChange={onChange}
                        />
                        {isPassword && (
                            <button type="button" onClick={() => setShowPass(!showPass)} className="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-700">
                                {showPass ? <EyeOff size={18}/> : <Eye size={18}/>}
                            </button>
                        )}
                    </div>
                </div>
            );
        };

        const AuthPage = ({ onLogin }) => {
            const [isRegister, setIsRegister] = useState(false);
            const [isLoading, setIsLoading] = useState(false);
            const [formData, setFormData] = useState({ name: '', email: '', password: '', confirmPassword: '' });
            const [error, setError] = useState('');
            const [successMsg, setSuccessMsg] = useState('');

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError('');
                setSuccessMsg('');
                setIsLoading(true);

                const endpoint = isRegister ? '/api/auth/daftar' : '/api/auth/masuk';
                const body = isRegister 
                    ? { nama: formData.name, email: formData.email, password: formData.password }
                    : { email: formData.email, password: formData.password };

                if (isRegister && formData.password !== formData.confirmPassword) {
                    setError("Konfirmasi password tidak cocok");
                    setIsLoading(false);
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(body)
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(getFriendlyError(data.pesanError) || "Terjadi kesalahan");
                    }

                    // MODIFIED: Menggunakan token dari state, bukan cookie
                    if (data.token) {
                        // Pass user data dan token ke App
                        onLogin(data.admin || { name: formData.name || 'Admin', email: formData.email }, data.token);
                    } else if (isRegister) {
                        setSuccessMsg("Registrasi Berhasil! Silakan masuk.");
                        setIsRegister(false);
                        setFormData({ name: '', email: '', password: '', confirmPassword: '' });
                    } else {
                        setError("Token tidak diterima dari server.");
                    }
                } catch (err) {
                    setError(err.message);
                } finally {
                    setIsLoading(false);
                }
            };

            const toggleMode = () => {
                setIsRegister(!isRegister);
                setError('');
                setSuccessMsg('');
                setFormData({ name: '', email: '', password: '', confirmPassword: '' });
            };

            return (
                <div className="min-h-screen flex w-full bg-white lg:bg-[#F7F7F7]">
                    <BrandSidebar />
                    <div className="w-full lg:w-1/2 lg:ml-auto flex items-center justify-center p-8 lg:p-16 bg-white animate-fade-in min-h-screen">
                        <div className="w-full max-w-md space-y-8">
                            <div className="text-center lg:text-left">
                                <h2 className="text-3xl font-bold text-gray-800">{isRegister ? 'Buat Akun Baru' : 'Selamat Datang'}</h2>
                                <p className="text-gray-500 mt-2">{isRegister ? 'Lengkapi data untuk akses SIMRS.' : 'Masuk untuk mengakses dashboard.'}</p>
                            </div>

                            {error && (
                                <div className="bg-red-50 text-red-600 p-4 rounded-xl text-sm flex items-start gap-3 border border-red-100 animate-fade-in">
                                    <AlertCircle className="shrink-0 mt-0.5" size={16}/> <span>{error}</span>
                                </div>
                            )}
                            {successMsg && (
                                <div className="bg-green-50 text-green-700 p-4 rounded-xl text-sm flex items-start gap-3 border border-green-100 animate-fade-in">
                                    <CheckCircle className="shrink-0 mt-0.5" size={16}/> <span>{successMsg}</span>
                                </div>
                            )}

                            <form onSubmit={handleSubmit} className="space-y-5">
                                {isRegister && (
                                    <InputField label="Nama Lengkap" type="text" placeholder="Contoh: Budi Santoso" icon={User} value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} />
                                )}
                                <InputField label="Email" type="email" placeholder="nama@rs.com" icon={Mail} value={formData.email} onChange={e => setFormData({...formData, email: e.target.value})} />
                                <InputField label="Password" type="password" placeholder="Minimal 6 karakter" icon={Lock} value={formData.password} onChange={e => setFormData({...formData, password: e.target.value})} />
                                {isRegister && (
                                    <InputField label="Konfirmasi Password" type="password" placeholder="Ulangi password" icon={CheckCircle} value={formData.confirmPassword} onChange={e => setFormData({...formData, confirmPassword: e.target.value})} />
                                )}

                                <button type="submit" disabled={isLoading} className="w-full bg-[#17B8A5] hover:bg-[#129485] text-white font-bold py-3.5 rounded-xl transition-all shadow-lg hover:shadow-teal-500/30 flex items-center justify-center gap-2 mt-6 disabled:opacity-70 disabled:cursor-not-allowed">
                                    {isLoading ? (
                                        <span className="flex items-center gap-2"><div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div> Memproses...</span>
                                    ) : (isRegister ? 'Daftar Sekarang' : 'Masuk Dashboard')}
                                </button>
                            </form>

                            <div className="text-center pt-4 border-t border-gray-100 mt-6">
                                <p className="text-sm text-gray-600">
                                    {isRegister ? 'Sudah punya akun? ' : 'Belum punya akun? '}
                                    <button onClick={toggleMode} className="text-[#17B8A5] font-bold hover:underline transition-colors ml-1">
                                        {isRegister ? 'Masuk sekarang' : 'Daftar di sini'}
                                    </button>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- COMPONENTS UTILS ---
        const Modal = ({ isOpen, onClose, title, children, large = false }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 animate-fade-in">
                    <div className={`bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full ${large ? 'max-w-4xl' : 'max-w-3xl'} max-h-[90vh] overflow-hidden flex flex-col border border-gray-100 dark:border-gray-700`}>
                        <div className="flex justify-between items-center p-5 border-b border-gray-100 dark:border-gray-700 bg-gray-50 dark:bg-gray-900">
                            <h3 className="text-lg font-bold text-gray-800 dark:text-white">{title}</h3>
                            <button onClick={onClose} className="p-2 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-full text-gray-500 dark:text-gray-400 transition-colors"><X size={20}/></button>
                        </div>
                        <div className="p-0 overflow-y-auto flex-1">{children}</div>
                    </div>
                </div>
            );
        };

        // --- USER SETTINGS MODAL ---
        const UserSettingsModal = ({ isOpen, onClose, user, onLogout, currentTheme, onThemeChange }) => {
            if (!isOpen) return null;
            return (
                <Modal isOpen={isOpen} onClose={onClose} title="Pengaturan Akun" large={false}>
                    <div className="flex h-[400px] flex-col md:flex-row">
                        <div className="w-full md:w-1/3 bg-gray-50 dark:bg-gray-900 border-r border-gray-100 dark:border-gray-700 p-4">
                            <nav className="space-y-1">
                                <button className="w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium bg-white dark:bg-gray-700 text-[#17B8A5] shadow-sm"><User size={18}/> Profil Saya</button>
                            </nav>
                            <div className="mt-auto pt-8">
                                <button onClick={onLogout} className="w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 transition">
                                    <LogOut size={18}/> Keluar Aplikasi
                                </button>
                            </div>
                        </div>
                        <div className="flex-1 p-6 overflow-y-auto">
                            <div className="space-y-6">
                                <h4 className="text-gray-800 dark:text-white font-bold">Tema Aplikasi</h4>
                                <div className="grid grid-cols-2 gap-4">
                                    <div onClick={() => onThemeChange('light')} className={`border-2 rounded-xl p-4 cursor-pointer flex flex-col items-center gap-2 transition ${currentTheme === 'light' ? 'border-[#17B8A5] bg-blue-50 dark:bg-gray-700' : 'border-gray-200 dark:border-gray-700'}`}>
                                        <Sun className="text-orange-400" size={32}/>
                                        <span className="font-bold text-sm dark:text-white">Terang</span>
                                    </div>
                                    <div onClick={() => onThemeChange('dark')} className={`border-2 rounded-xl p-4 cursor-pointer flex flex-col items-center gap-2 transition ${currentTheme === 'dark' ? 'border-[#17B8A5] bg-gray-800' : 'border-gray-200 dark:border-gray-700'}`}>
                                        <Moon className="text-indigo-400" size={32}/>
                                        <span className="font-bold text-sm dark:text-white">Gelap</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </Modal>
            );
        };

        // --- ASISTEN HR CERDAS ---
        const SmartHRAssistant = ({ staffData }) => {
            const [messages, setMessages] = useState([
                { id: 1, sender: 'bot', text: 'Halo! Saya Asisten HR. Saya bisa membantu mengecek data SIP, statistik, atau pencarian. Apa yang ingin Anda ketahui?', quickReplies: ['Cek SIP Expired', 'Total Dokter', 'Cek Perawat'] }
            ]);
            const [input, setInput] = useState('');
            const [isTyping, setIsTyping] = useState(false);
            const scrollRef = useRef(null);

            useEffect(() => scrollRef.current?.scrollIntoView({ behavior: "smooth" }), [messages, isTyping]);

            const handleSend = (text = input) => {
                if (!text.trim()) return;
                setMessages(prev => [...prev, { id: Date.now(), sender: 'user', text }]);
                setInput('');
                setIsTyping(true);

                setTimeout(() => {
                    let response = { text: "Maaf, saya tidak mengerti. Coba gunakan kata kunci 'SIP', 'Total', atau nama profesi.", data: null };
                    const lower = text.toLowerCase();

                    if (lower.includes('sip') || lower.includes('expired')) {
                        const missingSip = staffData.filter(s => !s.sipUrl && (s.category.includes('Dokter') || s.category.includes('Perawat')));
                        response.text = missingSip.length > 0 ? `Ditemukan ${missingSip.length} pegawai medis tanpa upload SIP.` : "Semua data SIP terlihat aman (berdasarkan data yang ada).";
                        response.data = missingSip.map(s => ({ title: s.name, desc: s.unit }));
                    } else if (lower.includes('total') || lower.includes('dokter')) {
                        const docs = staffData.filter(s => s.category.toLowerCase().includes('dokter'));
                        response.text = `Total ada ${docs.length} dokter terdaftar.`;
                        response.data = docs.map(s => ({ title: s.name, desc: s.category }));
                    } else if (lower.includes('perawat')) {
                        const nurses = staffData.filter(s => s.category.toLowerCase().includes('perawat'));
                        response.text = `Total ada ${nurses.length} perawat terdaftar.`;
                        response.data = nurses.map(s => ({ title: s.name, desc: s.unit }));
                    }

                    setMessages(prev => [...prev, { id: Date.now()+1, sender: 'bot', ...response }]);
                    setIsTyping(false);
                }, 800);
            };

            return (
                <div className="flex flex-col h-[calc(100vh-140px)] bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden animate-fade-in">
                    <div className="bg-[#17B8A5] p-4 flex items-center gap-3 text-white shadow-sm">
                        <div className="p-2 bg-white/20 rounded-full"><Bot size={24}/></div>
                        <div><h3 className="font-bold">Asisten HR</h3><p className="text-xs opacity-90">Online â€¢ AI Support</p></div>
                    </div>
                    <div className="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50 dark:bg-gray-900">
                        {messages.map(msg => (
                            <div key={msg.id} className={`flex flex-col ${msg.sender === 'user' ? 'items-end' : 'items-start'}`}>
                                <div className={`max-w-[80%] p-3.5 rounded-2xl text-sm ${msg.sender === 'user' ? 'bg-[#17B8A5] text-white rounded-tr-none' : 'bg-white dark:bg-gray-700 dark:text-gray-200 border border-gray-200 dark:border-gray-600 rounded-tl-none shadow-sm'}`}>
                                    {msg.text}
                                </div>
                                {msg.data && (
                                    <div className="mt-2 w-[80%] bg-white dark:bg-gray-700 rounded-xl border border-gray-200 dark:border-gray-600 overflow-hidden shadow-sm">
                                        <div className="max-h-48 overflow-y-auto divide-y divide-gray-100 dark:divide-gray-600">
                                            {msg.data.map((d, i) => (
                                                <div key={i} className="p-3 text-sm hover:bg-gray-50 dark:hover:bg-gray-600">
                                                    <p className="font-bold text-gray-800 dark:text-gray-200">{d.title}</p>
                                                    <p className="text-xs text-gray-500 dark:text-gray-400">{d.desc}</p>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                                {msg.quickReplies && (
                                    <div className="flex flex-wrap gap-2 mt-2">
                                        {msg.quickReplies.map(r => (
                                            <button key={r} onClick={() => handleSend(r)} className="text-xs px-3 py-1.5 bg-white dark:bg-gray-700 border border-[#17B8A5] text-[#17B8A5] rounded-full hover:bg-[#F0FDFA] transition">{r}</button>
                                        ))}
                                    </div>
                                )}
                            </div>
                        ))}
                        {isTyping && <div className="p-3 bg-white dark:bg-gray-700 rounded-2xl w-16 flex justify-center gap-1"><div className="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div><div className="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div><div className="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div></div>}
                        <div ref={scrollRef}/>
                    </div>
                    <form onSubmit={(e) => {e.preventDefault(); handleSend();}} className="p-4 bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 flex gap-2">
                        <input value={input} onChange={e => setInput(e.target.value)} placeholder="Tanya sesuatu..." className="flex-1 px-4 py-2 border rounded-full dark:bg-gray-700 dark:border-gray-600 dark:text-white focus:outline-none focus:border-[#17B8A5]"/>
                        <button type="submit" className="p-2.5 bg-[#17B8A5] text-white rounded-full hover:bg-[#0F8F80] transition"><Send size={18}/></button>
                    </form>
                </div>
            );
        };

        // --- DASHBOARD ---
        const Dashboard = ({ staffData }) => {
            const [modalData, setModalData] = useState({ isOpen: false, title: '', list: [] });

            const getStaffByCategory = (cats) => staffData.filter(s => cats.includes(s.category));

            const openListModal = (title, dataList) => {
                setModalData({ isOpen: true, title, list: dataList });
            };

            const WidgetCard = ({ title, count, icon: Icon, colorClass, borderColorClass, onClick }) => (
                <div onClick={onClick} className={`bg-white dark:bg-gray-800 p-5 rounded-xl shadow-sm border-l-4 ${borderColorClass} cursor-pointer hover:shadow-lg hover:-translate-y-1 transition-all duration-300 group`}>
                    <div className="flex justify-between items-start">
                        <div><p className="text-gray-500 dark:text-gray-400 text-xs font-bold uppercase tracking-wider">{title}</p><h3 className="text-3xl font-bold text-gray-800 dark:text-white mt-2 group-hover:text-[#17B8A5] transition-colors">{count}</h3></div>
                        <div className={`p-3 rounded-lg bg-gray-50 dark:bg-gray-700 ${colorClass} group-hover:bg-white transition-colors`}><Icon size={24} /></div>
                    </div>
                    <p className={`text-xs mt-4 font-semibold flex items-center gap-1 ${colorClass.replace('text-', 'text-opacity-80 text-')}`}>Lihat Daftar <ChevronRight size={12}/></p>
                </div>
            );

            return (
                <div className="space-y-8 animate-fade-in">
                    <div><h2 className="text-2xl font-bold text-[#2C2C2C] dark:text-white">Dashboard Operasional SDM</h2><p className="text-gray-500 dark:text-gray-400 text-sm">Ringkasan data pegawai dan status operasional hari ini.</p></div>
                    
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <WidgetCard title="Dokter" count={getStaffByCategory(JOB_CATEGORIES.MEDIS).length} icon={Stethoscope} colorClass="text-[#17B8A5]" borderColorClass="border-[#17B8A5]" onClick={() => openListModal('Daftar Dokter', getStaffByCategory(JOB_CATEGORIES.MEDIS))} />
                        <WidgetCard title="Perawat & Bidan" count={getStaffByCategory(JOB_CATEGORIES.KEPERAWATAN).length} icon={Users} colorClass="text-pink-500" borderColorClass="border-pink-500" onClick={() => openListModal('Daftar Perawat & Bidan', getStaffByCategory(JOB_CATEGORIES.KEPERAWATAN))} />
                        <WidgetCard title="Penunjang Medis" count={getStaffByCategory(JOB_CATEGORIES.PENUNJANG).length} icon={Activity} colorClass="text-purple-500" borderColorClass="border-purple-500" onClick={() => openListModal('Daftar Penunjang Medis', getStaffByCategory(JOB_CATEGORIES.PENUNJANG))} />
                        <WidgetCard title="Non-Medis" count={getStaffByCategory(JOB_CATEGORIES.NON_MEDIS).length} icon={Shield} colorClass="text-gray-600" borderColorClass="border-gray-600" onClick={() => openListModal('Daftar Non-Medis', getStaffByCategory(JOB_CATEGORIES.NON_MEDIS))} />
                    </div>

                    <div className="bg-white dark:bg-gray-800 rounded-xl shadow-sm overflow-hidden border border-gray-200 dark:border-gray-700">
                        <div className="p-5 border-b border-gray-100 dark:border-gray-700 flex justify-between items-center bg-gray-50 dark:bg-gray-900">
                            <h3 className="font-bold text-gray-800 dark:text-white flex items-center gap-2">Data Kepegawaian Terbaru</h3>
                        </div>
                        <div className="p-5 overflow-x-auto">
                           <table className="w-full text-sm text-left">
                                <thead className="bg-gray-50 dark:bg-gray-700 font-bold dark:text-gray-200">
                                    <tr><th className="p-4">Nama</th><th className="p-4">Profesi</th><th className="p-4">Unit</th></tr>
                                </thead>
                                <tbody className="dark:text-gray-200">
                                    {staffData.slice(0, 5).map(s => (
                                        <tr key={s.id} className="border-b dark:border-gray-700">
                                            <td className="p-4 font-bold">{s.name}</td>
                                            <td className="p-4">{s.category}</td>
                                            <td className="p-4">{s.unit}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <Modal isOpen={modalData.isOpen} onClose={() => setModalData({...modalData, isOpen: false})} title={modalData.title}>
                        <div className="overflow-x-auto"><table className="w-full text-sm text-left"><thead className="bg-gray-50 dark:bg-gray-700 font-bold dark:text-gray-200"><tr><th className="p-4">Nama</th><th className="p-4">Unit</th><th className="p-4">Jabatan</th></tr></thead><tbody className="dark:text-gray-200">{modalData.list.map(s => <tr key={s.id} className="border-b dark:border-gray-700"><td className="p-4 font-bold">{s.name}</td><td className="p-4">{s.unit}</td><td className="p-4">{s.role}</td></tr>)}</tbody></table></div>
                    </Modal>
                </div>
            );
        };

        // --- STAFF DIRECTORY & CRUD ---
        const StaffForm = ({ staffToEdit, onComplete, onCancel, token }) => {
            const isEdit = !!staffToEdit;
            const [isLoading, setIsLoading] = useState(false);
            const [availableUnits, setAvailableUnits] = useState(UNIT_MAPPING['Dokter Umum'] || []);
            const [sipFile, setSipFile] = useState(null);
            
            const [formData, setFormData] = useState({ 
                employeeId: '', name: '', role: '', unit: '', category: 'Dokter Umum', employeeType: 'Tetap', 
                sipNumber: '', sipExpiry: '', gender: 'Laki-laki', 
                birthPlace: '', birthDate: '', phone: '', email: '', address: ''
            });

            useEffect(() => {
                if (staffToEdit) {
                    // Populate Form
                    const catString = staffToEdit.category || 'Dokter Umum';
                    const unitList = UNIT_MAPPING[catString] || [];
                    setAvailableUnits(unitList);
                    setFormData({
                        employeeId: staffToEdit.employeeId,
                        name: staffToEdit.name,
                        role: staffToEdit.role,
                        unit: staffToEdit.unit,
                        category: catString,
                        employeeType: staffToEdit.employeeType,
                        sipNumber: staffToEdit.sipNumber || '',
                        sipExpiry: staffToEdit.sipExpiry || '',
                        gender: staffToEdit.gender,
                        birthPlace: '', 
                        birthDate: '',
                        phone: staffToEdit.phone,
                        email: staffToEdit.email,
                        address: staffToEdit.address
                    });
                }
            }, [staffToEdit]);

            const handleChange = (e) => { 
                const { name, value } = e.target; 
                if (name === 'category') { 
                    const newUnits = UNIT_MAPPING[value] || []; 
                    setAvailableUnits(newUnits); 
                    setFormData(prev => ({ ...prev, [name]: value, unit: newUnits[0] || '' })); 
                } else { 
                    setFormData(prev => ({ ...prev, [name]: value })); 
                } 
            };

            const handleFileChange = (e) => {
                if(e.target.files[0]) setSipFile(e.target.files[0]);
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                setIsLoading(true);

                // Construct FormData for multipart
                const data = new FormData();
                data.append('namaLkG', formData.name);
                data.append('nip', formData.employeeId);
                data.append('jenisKelamin', MAPPING.GENDER[formData.gender] || 'LAKI_LAKI');
                data.append('alamat', formData.address);
                data.append('noTelp', formData.phone);
                data.append('email', formData.email);
                data.append('kategoriProfesi', MAPPING.PROFESI_TO_ENUM[formData.category]);
                data.append('kategoriUnitKerja', MAPPING.UNIT_TO_ENUM[formData.unit]);
                data.append('jabatanSpesifik', formData.role);
                data.append('statusKepegawaian', MAPPING.STATUS[formData.employeeType]);
                data.append('peran', getPeranFromCategory(MAPPING.PROFESI_TO_ENUM[formData.category]));

                if(sipFile) {
                    data.append('sip', sipFile);
                }

                // API Endpoint
                const endpoint = isEdit ? '/api/staff/update' : '/api/staff/input';
                const method = isEdit ? 'PUT' : 'POST';

                try {
                    const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                        method: method,
                        headers: {
                            'x-auth-token': token // Use token from prop
                        },
                        body: data
                    });

                    const result = await response.json();

                    if (!response.ok) throw new Error(getFriendlyError(result.pesanError) || "Gagal menyimpan data");

                    alert("Data berhasil disimpan!");
                    onComplete();
                } catch (err) {
                    alert(err.message);
                } finally {
                    setIsLoading(false);
                }
            };

            const ChevronDownIcon = () => <ChevronRight className="rotate-90 text-gray-400" size={16}/>;

            return (
                <div className="space-y-6 animate-fade-in max-w-5xl mx-auto pb-10">
                    <div className="flex justify-between items-center">
                        <h2 className="text-2xl font-bold text-[#2C2C2C] dark:text-white">{isEdit ? 'Edit Data SDM' : 'Input Data SDM Baru'}</h2>
                        {isEdit && <button onClick={onCancel} className="text-gray-500 hover:text-gray-700">Batal</button>}
                    </div>

                    <form onSubmit={handleSubmit} className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div className="space-y-4">
                            <h3 className="font-bold border-b pb-2 dark:text-white">Data Pribadi</h3>
                            <div><label className="text-xs font-bold uppercase dark:text-gray-400">NIP</label><input required name="employeeId" value={formData.employeeId} onChange={handleChange} className="w-full mt-1 px-4 py-2 border rounded-lg dark:bg-gray-700 dark:text-white" /></div>
                            <div><label className="text-xs font-bold uppercase dark:text-gray-400">Nama Lengkap</label><input required name="name" value={formData.name} onChange={handleChange} className="w-full mt-1 px-4 py-2 border rounded-lg dark:bg-gray-700 dark:text-white" /></div>
                             <div>
                                <label className="text-xs font-bold uppercase dark:text-gray-400">Jenis Kelamin</label>
                                <select name="gender" value={formData.gender} onChange={handleChange} className="w-full mt-1 px-4 py-2 border rounded-lg dark:bg-gray-700 dark:text-white">
                                    <option value="Laki-laki">Laki-laki</option>
                                    <option value="Perempuan">Perempuan</option>
                                </select>
                            </div>
                            <div><label className="text-xs font-bold uppercase dark:text-gray-400">Email</label><input type="email" name="email" value={formData.email} onChange={handleChange} className="w-full mt-1 px-4 py-2 border rounded-lg dark:bg-gray-700 dark:text-white" /></div>
                            <div><label className="text-xs font-bold uppercase dark:text-gray-400">No. Telepon</label><input name="phone" value={formData.phone} onChange={handleChange} className="w-full mt-1 px-4 py-2 border rounded-lg dark:bg-gray-700 dark:text-white" /></div>
                            <div><label className="text-xs font-bold uppercase dark:text-gray-400">Alamat</label><textarea name="address" value={formData.address} onChange={handleChange} className="w-full mt-1 px-4 py-2 border rounded-lg dark:bg-gray-700 dark:text-white"></textarea></div>
                        </div>

                        <div className="space-y-4">
                            <h3 className="font-bold border-b pb-2 dark:text-white">Data Kepegawaian</h3>
                            <div><label className="text-xs font-bold uppercase dark:text-gray-400">Jabatan Spesifik</label><input required name="role" value={formData.role} onChange={handleChange} className="w-full mt-1 px-4 py-2 border rounded-lg dark:bg-gray-700 dark:text-white" /></div>
                            <div>
                                <label className="text-xs font-bold uppercase dark:text-gray-400">Profesi</label>
                                <select name="category" value={formData.category} onChange={handleChange} className="w-full mt-1 px-4 py-2 border rounded-lg dark:bg-gray-700 dark:text-white">
                                    <optgroup label="Medis">{JOB_CATEGORIES.MEDIS.map(c => <option key={c} value={c}>{c}</option>)}</optgroup>
                                    <optgroup label="Keperawatan">{JOB_CATEGORIES.KEPERAWATAN.map(c => <option key={c} value={c}>{c}</option>)}</optgroup>
                                    <optgroup label="Penunjang">{JOB_CATEGORIES.PENUNJANG.map(c => <option key={c} value={c}>{c}</option>)}</optgroup>
                                    <optgroup label="Non-Medis">{JOB_CATEGORIES.NON_MEDIS.map(c => <option key={c} value={c}>{c}</option>)}</optgroup>
                                </select>
                            </div>
                            <div>
                                <label className="text-xs font-bold uppercase dark:text-gray-400">Unit Kerja</label>
                                <select name="unit" value={formData.unit} onChange={handleChange} className="w-full mt-1 px-4 py-2 border rounded-lg dark:bg-gray-700 dark:text-white">
                                    {availableUnits.map((u,i) => <option key={i} value={u}>{u}</option>)}
                                </select>
                            </div>
                            <div>
                                <label className="text-xs font-bold uppercase dark:text-gray-400">Status</label>
                                <select name="employeeType" value={formData.employeeType} onChange={handleChange} className="w-full mt-1 px-4 py-2 border rounded-lg dark:bg-gray-700 dark:text-white">
                                    <option value="Tetap">Pegawai Tetap</option>
                                    <option value="Kontrak">Kontrak</option>
                                    <option value="Mitra">Mitra</option>
                                </select>
                            </div>
                            <div>
                                <label className="text-xs font-bold uppercase dark:text-gray-400">Upload SIP (Gambar)</label>
                                <input type="file" accept="image/*" onChange={handleFileChange} className="w-full mt-1 px-4 py-2 border rounded-lg dark:bg-gray-700 dark:text-white" />
                                <p className="text-xs text-gray-400 mt-1">Kosongkan jika tidak ada perubahan atau tidak diperlukan.</p>
                            </div>

                            <button type="submit" disabled={isLoading} className="w-full px-6 py-3 mt-6 rounded-xl text-white font-bold bg-[#17B8A5] hover:bg-[#0F8F80] shadow-lg flex items-center justify-center gap-2">
                                {isLoading ? 'Menyimpan...' : <><Save size={20}/> Simpan Data</>}
                            </button>
                        </div>
                    </form>
                </div>
            );
        };

        const StaffDirectory = ({ staffData, onRefresh, onEdit }) => {
            const [filter, setFilter] = useState('All');
            const [search, setSearch] = useState('');
            
            const filteredData = staffData.filter(staff => (filter === 'All' || staff.category === filter) && (staff.name.toLowerCase().includes(search.toLowerCase()) || staff.unit.toLowerCase().includes(search.toLowerCase())));

            return (
                <div className="space-y-6 animate-fade-in">
                    <div className="flex flex-col md:flex-row justify-between gap-4 items-end md:items-center">
                        <div><h2 className="text-2xl font-bold dark:text-white">Direktori Pegawai</h2><p className="text-sm text-gray-500 dark:text-gray-400">Kelola data seluruh pegawai rumah sakit.</p></div>
                        <div className="flex flex-col sm:flex-row gap-3 w-full md:w-auto">
                             <button onClick={onRefresh} className="px-4 py-2 bg-gray-100 dark:bg-gray-700 rounded-lg text-sm font-bold hover:bg-gray-200 dark:hover:bg-gray-600 transition">Refresh Data</button>
                            <div className="relative flex-1"><Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" size={18} /><input type="text" placeholder="Cari Nama / Unit..." className="w-full pl-10 pr-4 py-2 border rounded-lg dark:bg-gray-800 dark:border-gray-700 dark:text-white focus:outline-none focus:border-[#17B8A5]" value={search} onChange={(e) => setSearch(e.target.value)}/></div>
                            <div className="relative"><Filter className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" size={18} /><select className="pl-10 pr-8 py-2 border rounded-lg appearance-none dark:bg-gray-800 dark:border-gray-700 dark:text-white focus:outline-none focus:border-[#17B8A5]" value={filter} onChange={(e) => setFilter(e.target.value)}><option value="All">Semua Profesi</option>{Object.keys(JOB_CATEGORIES).map(k => JOB_CATEGORIES[k].map(c => <option key={c} value={c}>{c}</option>))}</select><ChevronDown className="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none" size={14} /></div>
                        </div>
                    </div>

                    <div className="bg-white dark:bg-gray-800 rounded-xl shadow-sm overflow-visible border border-gray-200 dark:border-gray-700 min-h-[400px]">
                        <div className="overflow-x-auto">
                            <table className="w-full text-left">
                                <thead className="bg-gray-50 dark:bg-gray-700 border-b dark:border-gray-600 dark:text-gray-200"><tr><th className="px-6 py-4 text-xs font-bold text-gray-500 dark:text-gray-400 uppercase w-32">NIP</th><th className="px-6 py-4 text-xs font-bold text-gray-500 dark:text-gray-400 uppercase">Nama & Profesi</th><th className="px-6 py-4 text-xs font-bold text-gray-500 dark:text-gray-400 uppercase">Jabatan & Unit</th><th className="px-6 py-4 text-xs font-bold text-gray-500 dark:text-gray-400 uppercase text-right">Aksi</th></tr></thead>
                                <tbody className="divide-y divide-gray-100 dark:divide-gray-700 dark:text-gray-200">{filteredData.map((staff) => {
                                    let avatarColor = staff.category.includes('Dokter') ? 'bg-[#17B8A5]' : staff.category.includes('Perawat') ? 'bg-blue-400' : 'bg-gray-400';
                                    return (
                                        <tr key={staff.id} className="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors cursor-pointer group">
                                            <td className="px-6 py-4 align-top"><span className="font-mono text-xs font-bold text-gray-500 dark:text-gray-400 bg-gray-100 dark:bg-gray-600 px-2 py-1 rounded">{staff.employeeId}</span></td>
                                            <td className="px-6 py-4"><div className="flex items-center gap-3"><div className={`w-10 h-10 rounded-full flex items-center justify-center text-white font-bold text-sm shadow-sm ${avatarColor}`}>{staff.name.substring(0,2).toUpperCase()}</div><div><p className="font-bold text-gray-800 dark:text-gray-200 text-sm">{staff.name}</p><p className="text-xs text-gray-400">{staff.category}</p></div></div></td>
                                            <td className="px-6 py-4 align-middle"><p className="text-sm font-bold text-gray-700 dark:text-gray-300">{staff.role}</p><p className="text-xs text-gray-500 dark:text-gray-400">{staff.unit}</p></td>
                                            <td className="px-6 py-4 text-right align-middle">
                                                <button onClick={() => onEdit(staff)} className="px-3 py-1 bg-blue-50 text-blue-600 rounded text-xs font-bold border border-blue-200 hover:bg-blue-100">Edit</button>
                                            </td>
                                        </tr>
                                    )
                                })}</tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };

        const PerformanceModule = ({ staffData }) => {
            const [selectedId, setSelectedId] = useState(staffData[0]?.id);
            const staff = staffData.find(s => s.id === parseInt(selectedId));

            // Flatten logic for display
            // Note: API returns `kinerjaStaff` as object. We will adapt display to it.
            const kinerja = staff?.kinerjaStaff || {};

            return (
                <div className="space-y-6 animate-fade-in"><h2 className="text-2xl font-bold text-[#2C2C2C] dark:text-white">Evaluasi Kinerja</h2>
                    <div className="flex flex-col md:flex-row gap-6 h-[calc(100vh-200px)]">
                        <div className="w-full md:w-1/4 bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden flex flex-col h-full">
                            <div className="flex-1 overflow-y-auto p-2 space-y-1">{staffData.map(s => (<button key={s.id} onClick={() => setSelectedId(s.id)} className={`w-full text-left p-3 rounded-lg text-sm transition-all duration-200 ${selectedId === s.id ? 'bg-[#17B8A5] text-white shadow-md' : 'hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300'}`}><div className="font-bold">{s.name}</div><div className={`text-xs ${selectedId === s.id ? 'text-white/80' : 'text-gray-500 dark:text-gray-400'}`}>{s.unit}</div></button>))}</div>
                        </div>
                        <div className="w-full md:w-3/4 flex flex-col h-full bg-white dark:bg-gray-800 p-6 rounded-xl border border-gray-200 dark:border-gray-700">
                             {staff ? (
                                <div className="space-y-6">
                                    <h3 className="text-xl font-bold dark:text-white">Detail Kinerja: {staff.name}</h3>
                                    
                                    <div className="grid grid-cols-2 gap-4">
                                        <div className="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                            <p className="text-xs font-bold uppercase text-gray-500 dark:text-gray-300">Respon Time Pasien</p>
                                            <div className="flex justify-between mt-2">
                                                <span>Target: {kinerja.targetTimePasienBaru || '-'}</span>
                                                <span className="font-bold text-[#17B8A5]">{kinerja.realisasiTimePasienBaru || '-'}</span>
                                            </div>
                                        </div>
                                         <div className="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                            <p className="text-xs font-bold uppercase text-gray-500 dark:text-gray-300">Kepuasan Pasien</p>
                                            <div className="flex justify-between mt-2">
                                                <span>Target: {kinerja.targetKepuasanPasien || '-'}</span>
                                                <span className="font-bold text-[#17B8A5]">{kinerja.realisasiKepuasanPasien || '-'}</span>
                                            </div>
                                        </div>
                                    </div>

                                    <div>
                                        <h4 className="font-bold mb-2 dark:text-white">Perilaku Kerja</h4>
                                        <div className="space-y-2">
                                            <div className="flex justify-between border-b py-2 dark:border-gray-600 dark:text-gray-300"><span>Integritas</span><span>{kinerja.integritas || '-'}</span></div>
                                            <div className="flex justify-between border-b py-2 dark:border-gray-600 dark:text-gray-300"><span>Disiplin</span><span>{kinerja.disiplin || '-'}</span></div>
                                        </div>
                                    </div>

                                     <div>
                                        <h4 className="font-bold mb-2 dark:text-white">SKP</h4>
                                        <div className="flex gap-4">
                                            <span className="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-bold">Predikat: {kinerja.skpPredikat || '-'}</span>
                                            <span className="px-3 py-1 bg-green-100 text-green-800 rounded-full text-xs font-bold">Realisasi: {kinerja.skpRealisasi || '-'}</span>
                                        </div>
                                    </div>
                                </div>
                             ) : <p className="text-gray-400">Pilih pegawai.</p>}
                        </div>
                    </div>
                </div>
            );
        };

        const Sidebar = ({ activeTab, setActiveTab, onOpenSettings, user }) => (
            <div className="w-64 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 flex flex-col h-screen fixed left-0 top-0 z-50 transition-colors">
                <div className="h-16 flex items-center justify-center border-b border-gray-200 dark:border-gray-700"><h1 className="text-2xl font-bold text-[#17B8A5]">SIMRS<span className="text-gray-800 dark:text-white">HR</span></h1></div>
                <nav className="p-4 space-y-2 flex-1">
                    {[
                        { id: 'dashboard', icon: LayoutDashboard, label: 'Dashboard' },
                        { id: 'directory', icon: Users, label: 'Direktori Pegawai' },
                        { id: 'crud', icon: UserPlus, label: 'Input Data SDM' },
                        { id: 'performance', icon: Activity, label: 'Evaluasi Kinerja' },
                        { id: 'assistant', icon: Bot, label: 'Asisten HR' } 
                    ].map(item => (
                        <button key={item.id} onClick={() => setActiveTab(item.id)} className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium transition ${activeTab === item.id ? 'bg-[#17B8A5] text-white shadow-md' : 'text-gray-600 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-700'}`}>
                            <item.icon size={20}/> {item.label}
                        </button>
                    ))}
                </nav>
                <div onClick={onOpenSettings} className="p-4 border-t border-gray-100 dark:border-gray-700 bg-gray-50 dark:bg-gray-700/30 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer transition">
                    <div className="flex items-center gap-3">
                        <div className="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center font-bold text-gray-500 uppercase">
                            {user?.name ? user.name.substring(0,2) : 'AD'}
                        </div>
                        <div className="overflow-hidden">
                            <p className="text-sm font-bold text-gray-700 dark:text-gray-200 truncate">{user?.name || 'Admin HR'}</p>
                            <p className="text-xs text-gray-400">Pengaturan Akun</p>
                        </div>
                    </div>
                </div>
            </div>
        );

        // --- MAIN APP COMPONENT ---
        const App = () => {
            const [activeTab, setActiveTab] = useState('dashboard');
            const [staffData, setStaffData] = useState([]);
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [theme, setTheme] = useState('light');
            const [user, setUser] = useState(null);
            const [token, setToken] = useState(null); // TOKEN disimpan di State
            const [editingStaff, setEditingStaff] = useState(null); 

            // Fetch Staff Data
            const fetchStaffData = async (tokenOverride) => {
                const authToken = tokenOverride || token;
                if(!authToken) return;

                try {
                    const response = await fetch(`${API_BASE_URL}/api/staff/`, {
                        headers: { 'x-auth-token': authToken }
                    });
                    const result = await response.json();
                    
                    if(Array.isArray(result)) {
                        const transformed = result
                        .filter(item => !item.deletedAt)
                        .map(item => ({
                            id: item.id,
                            employeeId: item.nip,
                            name: item.namaLkG,
                            role: item.jabatanSpesifik,
                            unit: ENUM_TO_UNIT[item.kategoriUnitKerja] || item.kategoriUnitKerja,
                            category: ENUM_TO_PROFESI[item.kategoriProfesi] || item.kategoriProfesi,
                            employeeType: MAPPING.STATUS[item.statusKepegawaian] || item.statusKepegawaian,
                            email: item.email,
                            phone: item.noTelp,
                            address: item.alamat,
                            gender: MAPPING.GENDER[item.jenisKelamin],
                            sipUrl: item.sipUrl,
                            kinerjaStaff: item.kinerjaStaff || {}
                        }));
                        setStaffData(transformed);
                    }
                } catch (err) {
                    console.error("Gagal mengambil data:", err);
                }
            };

            const handleLogin = (userData, userToken) => {
                setUser(userData);
                setToken(userToken);
                // Langsung fetch data setelah login sukses
                fetchStaffData(userToken);
            };

            const handleLogout = () => {
                setUser(null);
                setToken(null);
                setStaffData([]);
                setIsSettingsOpen(false);
            };

            const handleThemeChange = (newTheme) => {
                setTheme(newTheme);
                if (newTheme === 'dark') document.documentElement.classList.add('dark');
                else document.documentElement.classList.remove('dark');
            };

            const handleEditStart = (staff) => {
                setEditingStaff(staff);
                setActiveTab('crud');
            };

            if (!user || !token) {
                return <AuthPage onLogin={handleLogin} />;
            }

            return (
                <div className="flex min-h-screen font-sans pl-64 bg-[#F7F7F7] dark:bg-gray-900 transition-colors">
                    <Sidebar activeTab={activeTab} setActiveTab={setActiveTab} onOpenSettings={() => setIsSettingsOpen(true)} user={user} />
                    <main className="flex-1 p-8 h-screen overflow-y-auto">
                        {activeTab === 'dashboard' && <Dashboard staffData={staffData} />}
                        {activeTab === 'directory' && <StaffDirectory staffData={staffData} onRefresh={() => fetchStaffData()} onEdit={handleEditStart} />}
                        {activeTab === 'crud' && (
                            <StaffForm 
                                token={token} // Pass token sebagai prop
                                staffToEdit={editingStaff}
                                onComplete={() => {
                                    fetchStaffData();
                                    setEditingStaff(null);
                                    setActiveTab('directory');
                                }} 
                                onCancel={() => {
                                    setEditingStaff(null);
                                    setActiveTab('directory');
                                }}
                            />
                        )}
                        {activeTab === 'performance' && <PerformanceModule staffData={staffData} />}
                        {activeTab === 'assistant' && <SmartHRAssistant staffData={staffData} />}
                    </main>
                    <UserSettingsModal isOpen={isSettingsOpen} onClose={() => setIsSettingsOpen(false)} currentTheme={theme} onThemeChange={handleThemeChange} user={user} onLogout={handleLogout} />
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>